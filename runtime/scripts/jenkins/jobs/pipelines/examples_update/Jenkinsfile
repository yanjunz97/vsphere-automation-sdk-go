pipeline {
    agent {label 'Linux'}
    environment {
        def BRANCH = 'master'
        def GORUNTIME_DIR = "$WORKSPACE"
        def GENERATE_EXAMPLES_DIR = "scripts/jenkins/jobs"
        def EXAMPLES_DIR = "${GORUNTIME_DIR}/examples"

    }
    stages {
        stage('checkout') {
            steps {
                cleanWs()
                checkout([$class: 'GitSCM', branches: [[name: 'master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: 'git@gitlab.eng.vmware.com:vapi/goruntime.git']]])
            }
        }

        stage('update') {
            steps {
                sh """
                cd "$GENERATE_EXAMPLES_DIR"
                bash generate_examples.sh
            """
            }
        }
        stage('push') {
            steps {
                sh """
                git fetch
                git checkout \${BRANCH}

                cd "\${EXAMPLES_DIR}"
                EXAMPLES_SUB_DIRS=( \$( ls .) )
                for SUB_DIR in "\${EXAMPLES_SUB_DIRS[@]}"
                do
                    git add "\${SUB_DIR}/server/bindings/*" "\${SUB_DIR}/client/bindings/*"
                    if [ -d "\${SUB_DIR}/server/metadata" ]; then
                        git add "\${SUB_DIR}/server/metadata/*"
                    fi
                done

                if [[ -n \$(git status --porcelain) ]]; then
                    git commit -m "Autogenerated commit from vapi-goruntime-examples-update job"
                    git push origin "$BRANCH"
                fi
                cd -
                echo "Successfully pushed changes"
            """
            }
        }
    }
}
